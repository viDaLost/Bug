<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–æ—è –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è</title>
  <meta name="theme-color" content="#e9d5ff" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --pastel-bg:#fafaff;
      --pastel-card:#ffffff;
      --pastel-accent:#c7d2fe;
      --pastel-primary:#a78bfa;
      --pastel-primary-strong:#8b5cf6;
      --pastel-success:#bbf7d0;
      --pastel-warning:#fde68a;
      --pastel-danger:#fecaca;
      --text:#1f2937;
    }
    .active-tab{ background: var(--pastel-primary); color:#fff; }
    .slide-in{ animation: slideIn .25s ease-out both; }
    @keyframes slideIn{ from{ transform:translateX(8px); opacity:.0;} to{ transform:none; opacity:1; } }
    .glass{ backdrop-filter:saturate(180%) blur(10px); background: rgba(255,255,255,.7); }
    .field-label{ @apply block text-gray-700 mb-1; }
    .field{ @apply w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-300; }
    .sec-card{ @apply p-4 rounded-xl border bg-white border-gray-100; }
    .hsep{ @apply mt-2 pt-2 border-t; }
  </style>
</head>
<body class="min-h-screen bg-[var(--pastel-bg)] text-[var(--text)] font-sans">
  <div class="container mx-auto max-w-md min-h-screen bg-[var(--pastel-card)] shadow-xl rounded-2xl overflow-hidden">
    <!-- Header -->
    <header class="bg-gradient-to-r from-[#f5e0ff] via-[#e9d5ff] to-[#dbeafe] p-4 shadow">
      <h1 class="text-xl font-bold text-center tracking-wide">–ú–æ—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è</h1>
      <p id="userBadge" class="mt-1 text-center text-xs text-gray-600">–ì–æ—Å—Ç—å ¬∑ –æ—Ñ–ª–∞–π–Ω</p>
    </header>

    <!-- Tabs -->
    <div class="flex border-b border-indigo-100 overflow-x-auto">
      <button id="expensesTab" class="flex-1 py-3 px-4 font-medium text-center active-tab rounded-b-none">üìë –ó–∞—Ç—Ä–∞—Ç—ã</button>
      <button id="ordersTab" class="flex-1 py-3 px-4 font-medium text-center text-gray-700 hover:bg-indigo-50">üßæ –ó–∞–∫–∞–∑—ã</button>
      <button id="analyticsTab" class="flex-1 py-3 px-4 font-medium text-center text-gray-700 hover:bg-indigo-50">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      <button id="adviceTab" class="flex-1 py-3 px-4 font-medium text-center text-gray-700 hover:bg-indigo-50">üßÆ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
    </div>

    <!-- Expenses Section -->
    <section id="expensesSection" class="p-4 space-y-6 slide-in">
      <div class="bg-indigo-50/70 p-4 rounded-xl border border-indigo-100">
        <h2 class="text-lg font-semibold mb-3 text-indigo-900">–î–æ–±–∞–≤–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã</h2>
        <div class="grid gap-3">
          <div>
            <label class="field-label">–ß—Ç–æ –∫—É–ø–∏–ª–∏</label>
            <input type="text" id="itemName" class="field">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
              <input type="number" id="itemQuantity" step="0.01" class="field">
            </div>
            <div>
              <label class="field-label">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
              <input type="number" id="itemPrice" step="0.01" class="field">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (—Ñ–∞–∫—Ç)</label>
              <input type="number" id="amountSpent" step="0.01" class="field">
            </div>
            <div>
              <label class="field-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <input type="text" id="itemCategory" placeholder="—Å—ã—Ä—å—ë, —É–ø–∞–∫–æ–≤–∫–∞‚Ä¶" class="field">
            </div>
          </div>
          <div>
            <label class="field-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
            <input type="text" id="itemNote" class="field">
          </div>
          <button id="addExpense" class="w-full bg-[var(--pastel-primary)] text-white py-2 rounded-xl hover:bg-[var(--pastel-primary-strong)] transition">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-indigo-900">–ò—Å—Ç–æ—Ä–∏—è –∑–∞—Ç—Ä–∞—Ç</h2>
          <input id="expenseSearch" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="px-3 py-2 text-sm border rounded-lg" />
        </div>
        <div id="expensesList" class="space-y-3"></div>
      </div>
    </section>

    <!-- Orders Section -->
    <section id="ordersSection" class="p-4 hidden space-y-6">
      <div class="bg-blue-50/70 p-4 rounded-xl border border-blue-100">
        <h2 class="text-lg font-semibold mb-3 text-blue-900">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</h2>
        <div class="grid gap-3">
          <div>
            <label class="field-label">–ö—É–¥–∞ (–º–∞–≥–∞–∑–∏–Ω/–∫–∞—Ñ–µ)</label>
            <input type="text" id="orderDestination" class="field">
          </div>
          <div>
            <label class="field-label">–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å</label>
            <textarea id="orderDescription" rows="2" class="field"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-label">–ö–æ–≥–¥–∞ –ø—Ä–∏–≤–µ–∑—Ç–∏</label>
              <input type="date" id="orderDeliveryDate" class="field">
            </div>
            <div>
              <label class="field-label">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</label>
              <input type="number" id="orderAmount" step="0.01" class="field">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-label">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</label>
              <select id="orderPaymentStatus" class="field">
                <option value="unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</option>
                <option value="deposit">–ó–∞–¥–∞—Ç–æ–∫</option>
                <option value="paid">–û–ø–ª–∞—á–µ–Ω–æ</option>
              </select>
            </div>
            <div>
              <label class="field-label">–ü–æ–ª—É—á–µ–Ω–æ (‚ÇΩ)</label>
              <input type="number" id="orderReceived" step="0.01" value="0" class="field">
            </div>
          </div>
          <button id="addOrder" class="w-full bg-[var(--pastel-primary)] text-white py-2 rounded-xl hover:bg-[var(--pastel-primary-strong)] transition">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-blue-900">–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h2>
          <input id="orderSearch" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="px-3 py-2 text-sm border rounded-lg" />
        </div>
        <div id="ordersList" class="space-y-3"></div>
      </div>
    </section>

    <!-- Analytics Section -->
    <section id="analyticsSection" class="p-4 hidden space-y-3">
      <h2 class="text-lg font-semibold text-purple-900">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div class="sec-card">
          <p class="text-gray-500">–ó–∞—Ç—Ä–∞—Ç—ã (–º–µ—Å—è—Ü)</p>
          <p id="mExp" class="text-lg font-bold">0 ‚ÇΩ</p>
        </div>
        <div class="sec-card">
          <p class="text-gray-500">–î–æ—Ö–æ–¥ (–º–µ—Å—è—Ü)</p>
          <p id="mInc" class="text-lg font-bold">0 ‚ÇΩ</p>
        </div>
        <div class="sec-card">
          <p class="text-gray-500">–ú–∞—Ä–∂–∞ (–ø–ª–∞–Ω)</p>
          <p id="mMargin" class="text-lg font-bold">0 ‚ÇΩ</p>
          <p id="mMarginHint" class="text-xs text-gray-500 mt-1">–ø–æ –Ω–∞—Ü–µ–Ω–∫–µ –∏–∑ ¬´–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏¬ª</p>
        </div>
        <div class="sec-card">
          <p class="text-gray-500">–û–ø–ª–∞—á–µ–Ω–æ (—Ñ–∞–∫—Ç)</p>
          <p id="mPaid" class="text-lg font-bold">0 ‚ÇΩ</p>
        </div>
      </div>
      <button id="exportCsv" class="mt-2 w-full border rounded-xl py-2 hover:bg-indigo-50">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      <div class="grid grid-cols-2 gap-2">
        <button id="backupBtn" class="border rounded-xl py-2 hover:bg-indigo-50">–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</button>
        <label class="border rounded-xl py-2 text-center cursor-pointer hover:bg-indigo-50">
          –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å <input id="restoreFile" type="file" accept="application/json" class="hidden">
        </label>
      </div>
    </section>

    <!-- Advice / Recommendations Section -->
    <section id="adviceSection" class="p-4 hidden space-y-4">
      <h2 class="text-lg font-semibold text-emerald-900">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</h2>

      <div class="sec-card">
        <div class="grid gap-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, –∑–∞ —à—Ç (‚ÇΩ)</label>
              <input type="number" id="recCostPerUnit" step="0.01" class="field" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 120">
            </div>
            <div class="flex items-end">
              <button id="fillFromLastExpense" class="w-full border rounded-xl py-2 hover:bg-indigo-50">–í–∑—è—Ç—å —Ü–µ–Ω—É –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞—Ç—Ä–∞—Ç—ã</button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-label">–ù–∞—Ü–µ–Ω–∫–∞ (%)</label>
              <input type="number" id="recMarkup" step="0.1" class="field" value="30">
            </div>
            <div>
              <label class="field-label">–ù–î–°</label>
              <div class="grid grid-cols-3 gap-2">
                <select id="vatMode" class="field">
                  <option value="none">–±–µ–∑ –ù–î–°</option>
                  <option value="included">–ù–î–° –≤ —Å–æ—Å—Ç–∞–≤–µ —Ü–µ–Ω—ã</option>
                  <option value="onTop">–ù–î–° —Å–≤–µ—Ä—Ö—É</option>
                </select>
                <input type="number" id="vatRate" class="field" step="0.1" value="20" title="–°—Ç–∞–≤–∫–∞ –ù–î–°, %">
                <span class="self-center text-sm text-gray-500">%</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-label">–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ</label>
              <div class="grid grid-cols-2 gap-2">
                <select id="roundMode" class="field">
                  <option value="nearest">–∫ –±–ª–∏–∂–∞–π—à–µ–º—É</option>
                  <option value="up">–≤–≤–µ—Ä—Ö</option>
                  <option value="down">–≤–Ω–∏–∑</option>
                </select>
                <div class="flex items-center gap-2">
                  <input type="number" id="roundStep" class="field" step="0.01" value="1">
                  <span class="text-sm text-gray-500">—à–∞–≥, ‚ÇΩ</span>
                </div>
              </div>
            </div>
            <div class="flex items-end">
              <button id="saveSettings" class="w-full bg-[var(--pastel-primary)] text-white py-2 rounded-xl hover:bg-[var(--pastel-primary-strong)]">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
          </div>
        </div>

        <div class="hsep">
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="sec-card">
              <p class="text-gray-500">–¶–µ–Ω–∞ –±–µ–∑ –ù–î–° (–ø–æ—Å–ª–µ –Ω–∞—Ü–µ–Ω–∫–∏)</p>
              <p id="outNet" class="text-lg font-bold">‚Äî</p>
            </div>
            <div class="sec-card">
              <p class="text-gray-500">–ù–î–°, ‚ÇΩ</p>
              <p id="outVat" class="text-lg font-bold">‚Äî</p>
            </div>
            <div class="sec-card col-span-2">
              <p class="text-gray-500">–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –∫ –æ–ø–ª–∞—Ç–µ</p>
              <p id="outGross" class="text-2xl font-extrabold text-emerald-700">‚Äî</p>
              <p id="outNote" class="text-xs text-gray-500 mt-1"></p>
            </div>
          </div>
        </div>
      </div>

      <div class="sec-card">
        <h3 class="font-semibold mb-2">–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä: —Ü–µ–Ω–∞ –∑–∞ –∫–≥ ‚Üî —Ü–µ–Ω–∞ –∑–∞ —à—Ç.</h3>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="field-label">–°—Ä–µ–¥–Ω—è—è –º–∞—Å—Å–∞ –∏–∑–¥–µ–ª–∏—è</label>
            <div class="flex gap-2">
              <input type="number" id="convWeight" class="field" step="0.1" value="100">
              <span class="self-center text-sm text-gray-500">–≥—Ä–∞–º–º</span>
            </div>
          </div>
          <div>
            <label class="field-label">–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ/–∫–≥)</label>
            <input type="number" id="convPerKg" class="field" step="0.01" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 800">
          </div>
          <div>
            <label class="field-label">–¶–µ–Ω–∞ –∑–∞ —à—Ç (‚ÇΩ/—à—Ç)</label>
            <input type="number" id="convPerPiece" class="field" step="0.01" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 80">
          </div>
          <div class="flex items-end">
            <div class="text-xs text-gray-500">
              –í–≤–µ–¥–∏—Ç–µ –ª—é–±—É—é –ø–∞—Ä—É –∑–Ω–∞—á–µ–Ω–∏–π (–º–∞—Å—Å–∞ + —Ü–µ–Ω–∞ –∫–≥ –ò–õ–ò –º–∞—Å—Å–∞ + —Ü–µ–Ω–∞ —à—Ç) ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ—Å—á–∏—Ç–∞–µ—Ç—Å—è.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Summary Card -->
    <div class="sticky bottom-0 left-0 right-0 bg-white/80 glass p-4 border-t">
      <div class="flex justify-between">
        <div class="text-center">
          <p class="text-sm text-gray-500">–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã</p>
          <p id="totalExpenses" class="font-bold text-rose-700">0 ‚ÇΩ</p>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-500">–û–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥</p>
          <p id="expectedIncome" class="font-bold text-indigo-700">0 ‚ÇΩ</p>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-500">–ü–æ–ª—É—á–µ–Ω–æ</p>
          <p id="receivedIncome" class="font-bold text-emerald-700">0 ‚ÇΩ</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* Telegram WebApp Auth */
    const tg = window.Telegram?.WebApp;
    let currentUser = { id: 'guest', name: '–ì–æ—Å—Ç—å' };
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      const u = tg.initDataUnsafe.user;
      currentUser = {
        id: String(u.id),
        name: [u.first_name, u.last_name].filter(Boolean).join(' ') || (u.username?('@'+u.username):'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')
      };
      try{ tg.expand(); tg.setHeaderColor('#e9d5ff'); tg.setBackgroundColor('#fafaff'); }catch(e){}
    }
    document.getElementById('userBadge').textContent = `${currentUser.name} ¬∑ ${navigator.onLine?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}`;

    /* IndexedDB wrapper */
    const DB_NAME = 'accbook_v3';
    const STORE = 'records';
    let dbPromise;
    function openDB(){
      if (dbPromise) return dbPromise;
      dbPromise = new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE)){
            db.createObjectStore(STORE, { keyPath: 'key' });
          }
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error);
      });
      return dbPromise;
    }
    async function idbSet(key, value){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx = db.transaction(STORE,'readwrite');
        tx.objectStore(STORE).put({key, value});
        tx.oncomplete=()=>res();
        tx.onerror=()=>rej(tx.error);
      });
    }
    async function idbGet(key){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx = db.transaction(STORE,'readonly');
        const r = tx.objectStore(STORE).get(key);
        r.onsuccess=()=>res(r.result?.value);
        r.onerror=()=>rej(r.error);
      });
    }
    const ns = (suffix)=> `${currentUser.id}:${suffix}`;

    /* Data state */
    let expenses = [];
    let orders = [];
    let settings = {
      recMarkup: 30,
      vatMode: 'none',   // 'none' | 'included' | 'onTop'
      vatRate: 20,
      roundMode: 'nearest', // 'nearest' | 'up' | 'down'
      roundStep: 1
    };

    async function loadState(){
      const migrated = await idbGet(ns('migrated_v3'));
      if (!migrated){
        // try to pull old data (v2 keys) once
        const oldExpenses = await idbGet(`${currentUser.id}:expenses`) ?? JSON.parse(localStorage.getItem('expenses')||'[]');
        const oldOrders = await idbGet(`${currentUser.id}:orders`) ?? JSON.parse(localStorage.getItem('orders')||'[]');
        if (oldExpenses.length || oldOrders.length){
          await idbSet(ns('expenses'), oldExpenses);
          await idbSet(ns('orders'), oldOrders);
        }
        await idbSet(ns('migrated_v3'), true);
      }
      expenses = (await idbGet(ns('expenses'))) || [];
      orders = (await idbGet(ns('orders'))) || [];
      settings = Object.assign(settings, (await idbGet(ns('settings'))) || {});
      // hydrate UI with settings
      $('recMarkup').value = settings.recMarkup;
      $('vatMode').value = settings.vatMode;
      $('vatRate').value = settings.vatRate;
      $('roundMode').value = settings.roundMode;
      $('roundStep').value = settings.roundStep;
    }
    async function saveState(){
      await idbSet(ns('expenses'), expenses);
      await idbSet(ns('orders'), orders);
    }
    async function saveSettings(){
      settings = {
        recMarkup: num($('recMarkup').value, 0),
        vatMode: $('vatMode').value,
        vatRate: num($('vatRate').value, 0),
        roundMode: $('roundMode').value,
        roundStep: Math.max(0.01, num($('roundStep').value, 1))
      };
      await idbSet(ns('settings'), settings);
    }

    /* UI helpers */
    const $ = (id)=> document.getElementById(id);
    const money = (n)=> (isFinite(n)? (Math.round(n*100)/100).toFixed(2) : '‚Äî') + ' ‚ÇΩ';
    const num = (v, def=0)=>{ const x = parseFloat(v); return isNaN(x)?def:x; };
    function roundBy(value, step, mode){
      if (!isFinite(value)) return value;
      step = step>0 ? step : 1;
      const q = value/step;
      let r = q;
      if (mode==='up') r = Math.ceil(q);
      else if (mode==='down') r = Math.floor(q);
      else r = Math.round(q); // nearest
      return r*step;
    }

    /* Renderers */
    function renderExpenses(filter=''){
      const container = $('expensesList');
      container.innerHTML = '';
      const list = expenses.filter(e=> JSON.stringify(e).toLowerCase().includes(filter.toLowerCase()));
      if (!list.length){ container.innerHTML = '<p class="text-gray-500 text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞—Ç—Ä–∞—Ç–∞—Ö</p>'; return; }
      list.slice().reverse().forEach(expense=>{
        const el = document.createElement('div');
        el.className = 'bg-white p-3 rounded-xl shadow border border-gray-100';
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-medium">${expense.name}</h3>
              <p class="text-xs text-gray-500">${expense.date} ¬∑ ${expense.category||'–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</p>
            </div>
            <div class="flex gap-2">
              <button data-take="${expense.id}" class="text-emerald-700 hover:underline text-sm">–í–∑—è—Ç—å –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
              <button data-edit="${expense.id}" class="text-indigo-600 hover:underline text-sm">–ò–∑–º.</button>
              <button data-del="${expense.id}" class="text-rose-500">üóëÔ∏è</button>
            </div>
          </div>
          <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
            <div><p class="text-gray-500">–ö–æ–ª-–≤–æ</p><p>${expense.quantity} —à—Ç</p></div>
            <div><p class="text-gray-500">–¶–µ–Ω–∞ –∑–∞ —à—Ç</p><p>${money(expense.price)}</p></div>
            <div><p class="text-gray-500">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</p><p>${money(expense.spent)}</p></div>
            <div><p class="text-gray-500">–ò—Ç–æ–≥–æ (—Ä–∞—Å—á—ë—Ç)</p><p>${money(expense.totalCost)}</p></div>
          </div>`;
        el.querySelector(`[data-del]`).onclick = async ()=>{
          if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –æ –∑–∞—Ç—Ä–∞—Ç–∞—Ö?')){
            expenses = expenses.filter(x=>x.id!==expense.id);
            await saveState(); renderExpenses(filter); updateSummary();
          }
        };
        el.querySelector(`[data-edit]`).onclick = ()=> editExpense(expense.id);
        el.querySelector(`[data-take]`).onclick = ()=>{
          $('recCostPerUnit').value = expense.price ?? '';
          toggleTab('advice');
          computeAdvice();
        };
        container.appendChild(el);
      });
    }

    function renderOrders(filter=''){
      const container = $('ordersList');
      container.innerHTML = '';
      const list = orders.filter(e=> JSON.stringify(e).toLowerCase().includes(filter.toLowerCase()));
      if (!list.length){ container.innerHTML = '<p class="text-gray-500 text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–∞—Ö</p>'; return; }

      list.slice().reverse().forEach(order=>{
        let badgeClass = 'bg-gray-100 text-gray-800';
        let statusText = '‚Äî';
        if(order.paymentStatus==='unpaid'){ badgeClass='bg-[var(--pastel-danger)] text-rose-900'; statusText='–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'; }
        if(order.paymentStatus==='deposit'){ badgeClass='bg-[var(--pastel-warning)] text-amber-900'; statusText='–ó–∞–¥–∞—Ç–æ–∫'; }
        if(order.paymentStatus==='paid'){ badgeClass='bg-[var(--pastel-success)] text-emerald-900'; statusText='–û–ø–ª–∞—á–µ–Ω–æ'; }
        const el = document.createElement('div');
        el.className = 'bg-white p-3 rounded-xl shadow border border-gray-100';
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-medium">${order.destination}</h3>
              <p class="text-xs text-gray-500">${order.date}</p>
            </div>
            <div class="flex gap-2">
              <button data-edit="${order.id}" class="text-indigo-600 hover:underline text-sm">–ò–∑–º.</button>
              <button data-del="${order.id}" class="text-rose-500">üóëÔ∏è</button>
            </div>
          </div>
          <div class="mt-2"><p class="text-gray-700 whitespace-pre-line">${order.description}</p></div>
          <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
            <div><p class="text-gray-500">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</p><p>${order.deliveryDate}</p></div>
            <div><p class="text-gray-500">–°—É–º–º–∞</p><p class="font-medium">${money(order.amount)}</p></div>
          </div>
          <div class="mt-2 pt-2 border-t flex items-center justify-between">
            <span class="px-2 py-1 rounded-full text-xs ${badgeClass}">${statusText}</span>
            <span class="text-xs text-gray-600">–ü–æ–ª—É—á–µ–Ω–æ: <b>${money(order.received||0)}</b></span>
          </div>`;
        el.querySelector(`[data-del]`).onclick = async ()=>{
          if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')){
            orders = orders.filter(x=>x.id!==order.id);
            await saveState(); renderOrders(filter); updateSummary();
          }
        };
        el.querySelector(`[data-edit]`).onclick = ()=> editOrder(order.id);
        container.appendChild(el);
      });
    }

    function updateSummary(){
      const totalExpenses = expenses.reduce((s,e)=> s + (e.spent||0), 0);
      const expectedIncome = orders.reduce((s,o)=> s + (o.amount||0), 0);
      const receivedIncome = orders.reduce((s,o)=> s + (o.received|| (o.paymentStatus==='paid'?o.amount:0) ), 0);
      $('totalExpenses').textContent = money(totalExpenses);
      $('expectedIncome').textContent = money(expectedIncome);
      $('receivedIncome').textContent = money(receivedIncome);

      // Monthly quick stats
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const isMonth = (d)=> (d||'').startsWith(ym);
      const mExp = expenses.filter(e=> isMonth(e.dateISO)).reduce((s,e)=> s+(e.spent||0), 0);
      const mInc = orders.filter(o=> isMonth(o.dateISO)).reduce((s,o)=> s+(o.amount||0), 0);
      const mPaid = orders.filter(o=> isMonth(o.dateISO)).reduce((s,o)=> s+(o.received||0), 0);

      // –ü–ª–∞–Ω–æ–≤–∞—è –º–∞—Ä–∂–∞ —Ç–µ–ø–µ—Ä—å = —Å—É–º–º–∞(–∏—Ç–æ–≥–æ_–∑–∞—Ç—Ä–∞—Ç–∞ * (–Ω–∞—Ü–µ–Ω–∫–∞% / 100))
      const markup = (settings.recMarkup||0)/100;
      const mMargin = expenses.filter(e=> isMonth(e.dateISO)).reduce((s,e)=> s+( (e.totalCost||0)*markup ), 0);

      if ($('mExp')){
        $('mExp').textContent = money(mExp);
        $('mInc').textContent = money(mInc);
        $('mPaid').textContent = money(mPaid);
        $('mMargin').textContent = money(mMargin);
      }
    }

    /* CRUD + handlers: Expenses / Orders */
    $('addExpense').addEventListener('click', async ()=>{
      const name = $('itemName').value.trim();
      const quantity = num($('itemQuantity').value);
      const price = num($('itemPrice').value);
      const spent = num($('amountSpent').value);
      const category = $('itemCategory').value.trim();
      const note = $('itemNote').value.trim();
      if (!name || !isFinite(quantity) || !isFinite(price) || !isFinite(spent)) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ'); return; }
      const totalCost = price * quantity;
      const now = new Date();
      const expense = { id: Date.now(), name, quantity, price, spent, totalCost, category, note, date: now.toLocaleDateString(), dateISO: now.toISOString().slice(0,7) };
      expenses.push(expense); await saveState(); renderExpenses($('expenseSearch').value); updateSummary();
      ['itemName','itemQuantity','itemPrice','amountSpent','itemCategory','itemNote'].forEach(id=> $(id).value='');
    });

    $('addOrder').addEventListener('click', async ()=>{
      const destination = $('orderDestination').value.trim();
      const description = $('orderDescription').value.trim();
      const deliveryDate = $('orderDeliveryDate').value;
      const amount = num($('orderAmount').value);
      const paymentStatus = $('orderPaymentStatus').value;
      const received = num($('orderReceived').value,0);
      if (!destination || !description || !deliveryDate || !isFinite(amount)) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ'); return; }
      const now = new Date();
      const order = { id: Date.now(), destination, description, deliveryDate, amount, paymentStatus, received, date: now.toLocaleDateString(), dateISO: now.toISOString().slice(0,7) };
      orders.push(order); await saveState(); renderOrders($('orderSearch').value); updateSummary();
      ['orderDestination','orderDescription','orderDeliveryDate','orderAmount','orderReceived'].forEach(id=> $(id).value=''); $('orderPaymentStatus').value='unpaid';
    });

    function editExpense(id){
      const e = expenses.find(x=>x.id===id); if(!e) return;
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ', e.name); if (name===null) return;
      const quantity = num(prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', e.quantity)); if(!isFinite(quantity)) return;
      const price = num(prompt('–¶–µ–Ω–∞ –∑–∞ —à—Ç', e.price)); if(!isFinite(price)) return;
      const spent = num(prompt('–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (—Ñ–∞–∫—Ç)', e.spent)); if(!isFinite(spent)) return;
      const category = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è', e.category||'')||'';
      const note = prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ', e.note||'')||'';
      e.name=name; e.quantity=quantity; e.price=price; e.spent=spent; e.category=category; e.note=note;
      e.totalCost = price*quantity;
      saveState().then(()=>{ renderExpenses($('expenseSearch').value); updateSummary(); });
    }

    function editOrder(id){
      const o = orders.find(x=>x.id===id); if(!o) return;
      const destination = prompt('–ö—É–¥–∞', o.destination); if(destination===null) return;
      const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ', o.description); if(description===null) return;
      const deliveryDate = prompt('–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–ì–ì–ì–ì-–ú–ú-–î–î)', o.deliveryDate)||o.deliveryDate;
      const amount = num(prompt('–°—É–º–º–∞', o.amount)); if(!isFinite(amount)) return;
      const status = prompt('–°—Ç–∞—Ç—É—Å (unpaid/deposit/paid)', o.paymentStatus)||o.paymentStatus;
      const received = num(prompt('–ü–æ–ª—É—á–µ–Ω–æ', o.received||0)); if(!isFinite(received)) return;
      o.destination=destination; o.description=description; o.deliveryDate=deliveryDate; o.amount=amount; o.paymentStatus=status; o.received=received;
      saveState().then(()=>{ renderOrders($('orderSearch').value); updateSummary(); });
    }

    /* Filters, Tabs, Export/Backup */
    $('expenseSearch').addEventListener('input', (e)=> renderExpenses(e.target.value));
    $('orderSearch').addEventListener('input', (e)=> renderOrders(e.target.value));

    $('expensesTab').onclick = ()=>{ toggleTab('expenses'); };
    $('ordersTab').onclick = ()=>{ toggleTab('orders'); };
    $('analyticsTab').onclick = ()=>{ toggleTab('analytics'); };
    $('adviceTab').onclick = ()=>{ toggleTab('advice'); };

    function toggleTab(which){
      const map = { expenses:'expensesSection', orders:'ordersSection', analytics:'analyticsSection', advice:'adviceSection' };
      for (const k of Object.keys(map)){
        $(map[k]).classList.toggle('hidden', k!==which);
        const tab = $(k+'Tab');
        if (tab){ tab.classList.toggle('active-tab', k===which); tab.classList.toggle('text-gray-700', k!==which); }
      }
    }

    $('exportCsv').onclick = ()=>{
      const rows = [
        ['type','id','date','name/destination','quantity','price','spent','totalCost','category','note','deliveryDate','amount','status','received']
      ];
      expenses.forEach(e=> rows.push(['expense', e.id, e.date, e.name, e.quantity, e.price, e.spent, e.totalCost, e.category||'', e.note||'', '', '', '', '']));
      orders.forEach(o=> rows.push(['order', o.id, o.date, o.destination, '', '', '', '', '', '', o.deliveryDate, o.amount, o.paymentStatus, o.received||0]));
      // add settings row
      rows.push(['settings','','','','','','','','','','','','','']);
      rows.push(['markup', settings.recMarkup, 'vatMode', settings.vatMode, 'vatRate', settings.vatRate, 'roundMode', settings.roundMode, 'roundStep', settings.roundStep]);
      const csv = rows.map(r=> r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'accbook_export.csv'; a.click();
    };

    $('backupBtn').onclick = ()=>{
      const data = { user: currentUser, expenses, orders, settings, ts: Date.now() };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'accbook_backup.json'; a.click();
    };

    $('restoreFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if (Array.isArray(data.expenses) && Array.isArray(data.orders)){
          expenses = data.expenses; orders = data.orders;
          if (data.settings) settings = Object.assign(settings, data.settings);
          await saveState(); await idbSet(ns('settings'), settings);
          // rehydrate UI with restored settings
          $('recMarkup').value = settings.recMarkup;
          $('vatMode').value = settings.vatMode;
          $('vatRate').value = settings.vatRate;
          $('roundMode').value = settings.roundMode;
          $('roundStep').value = settings.roundStep;
          renderExpenses($('expenseSearch').value); renderOrders($('orderSearch').value); updateSummary(); computeAdvice(); alert('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
        } else { alert('–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω'); }
      }catch(err){ alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'); }
      e.target.value = '';
    });

    /* Advice / Recommendation logic */
    function computeAdvice(){
      const cost = num($('recCostPerUnit').value);
      const m = num($('recMarkup').value, 0)/100;
      const vatRate = num($('vatRate').value, 0)/100;
      const vatMode = $('vatMode').value;
      const step = Math.max(0.01, num($('roundStep').value, 1));
      const rMode = $('roundMode').value;

      if (!isFinite(cost)) { $('outNet').textContent='‚Äî'; $('outVat').textContent='‚Äî'; $('outGross').textContent='‚Äî'; $('outNote').textContent=''; return; }

      // –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –±–µ–∑ –ù–î–° –ø–æ—Å–ª–µ –Ω–∞—Ü–µ–Ω–∫–∏
      let net = cost * (1+m);

      let gross, vatAmt, note = '';
      if (vatMode==='none'){
        // –±–µ–∑ –ù–î–°: –æ–∫—Ä—É–≥–ª—è–µ–º net, vat=0, gross=net
        net = roundBy(net, step, rMode);
        gross = net; vatAmt = 0;
        note = '–ù–î–° –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è';
      } else if (vatMode==='onTop'){
        // –ù–î–° —Å–≤–µ—Ä—Ö—É: —Å–Ω–∞—á–∞–ª–∞ –æ–∫—Ä—É–≥–ª—è–µ–º net, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –ù–î–°
        net = roundBy(net, step, rMode);
        vatAmt = net * vatRate;
        gross = roundBy(net + vatAmt, step, rMode);
        note = '–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Ü–µ–Ω–µ –±–µ–∑ –ù–î–°, –ù–î–° –¥–æ–±–∞–≤–ª–µ–Ω —Å–≤–µ—Ä—Ö—É';
      } else { // included
        // –ù–î–° –≤ —Å–æ—Å—Ç–∞–≤–µ —Ü–µ–Ω—ã: —Å–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç–∞–µ–º gross –∏ –æ–∫—Ä—É–≥–ª—è–µ–º –µ–≥–æ
        gross = roundBy(net * (1+vatRate), step, rMode);
        // –ø–µ—Ä–µ—Å—á—ë—Ç net –∏ –ù–î–° –∏–∑ –æ–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–≥–æ gross –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        net = +(gross / (1+vatRate)).toFixed(2);
        vatAmt = +(gross - net).toFixed(2);
        note = '–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Ü–µ–Ω–µ —Å –ù–î–° (–≤ —Å–æ—Å—Ç–∞–≤–µ —Ü–µ–Ω—ã)';
      }

      $('outNet').textContent = money(net);
      $('outVat').textContent = money(vatAmt);
      $('outGross').textContent = money(gross);
      $('outNote').textContent = note;
    }

    // Converter logic
    function computeConverter(from){
      const g = num($('convWeight').value);
      const perKg = num($('convPerKg').value);
      const perPiece = num($('convPerPiece').value);
      if (g<=0){ return; }
      const kgPerPiece = g/1000;

      if (from==='kg' && isFinite(perKg)){
        const p = perKg * kgPerPiece;
        $('convPerPiece').value = (Math.round(p*100)/100).toFixed(2);
      } else if (from==='piece' && isFinite(perPiece)){
        const p = perPiece / kgPerPiece;
        $('convPerKg').value = (Math.round(p*100)/100).toFixed(2);
      } else if (from==='weight'){
        // try recompute whichever field exists
        if (isFinite(perKg) && perKg>0){
          const p = perKg * kgPerPiece;
          $('convPerPiece').value = (Math.round(p*100)/100).toFixed(2);
        } else if (isFinite(perPiece) && perPiece>0){
          const p = perPiece / kgPerPiece;
          $('convPerKg').value = (Math.round(p*100)/100).toFixed(2);
        }
      }
    }

    // Events: Advice
    ['recCostPerUnit','recMarkup','vatMode','vatRate','roundMode','roundStep'].forEach(id=>{
      $(id).addEventListener('input', computeAdvice);
      $(id).addEventListener('change', computeAdvice);
    });
    $('saveSettings').addEventListener('click', async ()=>{
      await saveSettings();
      computeAdvice();
      updateSummary();
      alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    });
    $('fillFromLastExpense').addEventListener('click', ()=>{
      if (!expenses.length){ alert('–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –∑–∞—Ç—Ä–∞—Ç–∞—Ö'); return; }
      const last = expenses[expenses.length-1];
      $('recCostPerUnit').value = last.price ?? '';
      computeAdvice();
    });

    // Events: Converter
    $('convPerKg').addEventListener('input', ()=> computeConverter('kg'));
    $('convPerPiece').addEventListener('input', ()=> computeConverter('piece'));
    $('convWeight').addEventListener('input', ()=> computeConverter('weight'));

    /* App init */
    window.addEventListener('online', ()=> $('userBadge').textContent = `${currentUser.name} ¬∑ –æ–Ω–ª–∞–π–Ω`);
    window.addEventListener('offline', ()=> $('userBadge').textContent = `${currentUser.name} ¬∑ –æ—Ñ–ª–∞–π–Ω`);

    document.addEventListener('DOMContentLoaded', async ()=>{
      if ('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('./sw.js'); }catch(e){ console.warn('SW failed', e); } }
      await loadState();
      renderExpenses(); renderOrders(); updateSummary(); computeAdvice();
      const today = new Date().toISOString().split('T')[0];
      $('orderDeliveryDate').value = today;
    });
  </script>
</body>
</html>
